Date.prototype.format=function(format){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(format)){format=format.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var k in o){if(new RegExp("("+k+")").test(format)){format=format.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+o[k]).substr((""+o[k]).length))}}return format};Number.prototype.format=function(pattern){var strarr=this.toString().split(".");var fmtarr=pattern?pattern.split("."):[""];var retstr="";var str=strarr[0];var fmt=fmtarr[0];var i=str.length-1;var comma=false;for(var f=fmt.length-1;f>=0;f--){switch(fmt.substr(f,1)){case"#":if(i>=0){retstr=str.substr(i--,1)+retstr}break;case"0":if(i>=0){retstr=str.substr(i--,1)+retstr}else{retstr="0"+retstr}break;case",":comma=true;retstr=","+retstr;break}}if(i>=0){if(comma){var l=str.length;for(;i>=0;i--){retstr=str.substr(i,1)+retstr;if(i>0&&((l-i)%3)==0){retstr=","+retstr}}}else{retstr=str.substr(0,i+1)+retstr}}retstr=retstr+".";str=strarr.length>1?strarr[1]:"";fmt=fmtarr.length>1?fmtarr[1]:"";i=0;for(var f=0;f<fmt.length;f++){switch(fmt.substr(f,1)){case"#":if(i<str.length){retstr+=str.substr(i++,1)}break;case"0":if(i<str.length){retstr+=str.substr(i++,1)}else{retstr+="0"}break}}return retstr.replace(/^,+/,"").replace(/\.$/,"")};Number.format=function(num,pattern){num=Number(num);return num.format(pattern)};Number.prototype.toLessArray=function(){var arr=[],i=0;do{arr.push(i)}while(++i<this);return arr};Number.toLessArray=function(num){return Number(num).toLessArray()};Number.getMaxMin=function(array){var max=0,min=0,len=array.length;if(len>0){min=array[0];for(var i=0;i<len;i++){if(array[i]>max){max=array[i]}else{if(array[i]<min){min=array[i]}}}}return{max:max,min:min}};String.prototype.format=function(){var args=arguments;return this.replace(/\{(\d+)\}/g,function(m,i){return args[i]})};String.format=function(){if(arguments.length==0){return null}var str=arguments[0];for(var i=1;i<arguments.length;i++){var re=new RegExp("\\{"+(i-1)+"\\}","gm");str=str.replace(re,arguments[i])}return str};function Rect(x,y,w,h,data){this.getX1=function(){return x};this.getY1=function(){return y};this.setX1=function(newX){x=newX};this.setY1=function(newY){y=newY};this.getWidth=function(){return w};this.getHeight=function(){return h};this.getX2=function(){return this.getX1()+this.getWidth()};this.getY2=function(){return this.getY1()+this.getHeight()};this.getData=function(){return data}}Rect.prototype.isCross=function(other){var maxMinX=Number.getMaxMin([this.getX1(),this.getX2(),other.getX1(),other.getX2()]);var maxMinY=Number.getMaxMin([this.getY1(),this.getY2(),other.getY1(),other.getY2()]);var widthX=Math.abs(maxMinX.max-maxMinX.min);var width=this.getWidth()+other.getWidth();var heightY=Math.abs(maxMinY.max-maxMinY.min);var height=this.getHeight()+other.getHeight();if(width<widthX||height<heightY){return false}return true};Rect.prototype.toString=function(){var string="x: "+this.getX1()+", y: "+this.getY1()+", w: "+this.getWidth()+", h: "+this.getHeight();return string};function RandomPosition(rectArr,canvasSize,tryCount){this._rectArr=rectArr;this._canvasSize=canvasSize;this._tryCount=tryCount||1000;this._result=[];this._continue=true}RandomPosition.prototype.randomPosition=function(){return[Math.ceil(Math.random()*this._canvasSize[0])%this._canvasSize[0],Math.ceil(Math.random()*this._canvasSize[0])%this._canvasSize[1]]};RandomPosition.prototype.isAnyCross=function(rect){for(var i in this._rectArr){if(this._result[i].isCross(rect)){return true}}return false};RandomPosition.prototype.calculate=function(){var result=this._result=[];var source=this._rectArr;var size=this._canvasSize;var rect,oldRect,x,y,w,h,maxY=0;for(var i=0,len=source.length;i<len;i++){w=source[i][0];h=source[i][1];if(oldRect){x=oldRect.getX1()+oldRect.getWidth();y=0;if(maxY<oldRect.getY2()){maxY=oldRect.getY2()}}else{x=y=0}if(x+w>size[0]){x=0;y=maxY}rect=new Rect(x,y,w,h,source[i][2]);oldRect=rect;result.push(rect)}var total=result.length,count=total-1,pos,currRect,newRect,tryCount=0,isTimeout=false;while(this._continue&&count>=0){currRect=result[count];isTimeout=false;do{pos=this.randomPosition();if(tryCount++>this._tryCount){this.out("RandomPosition timeout - currentPos: "+pos);count--;isTimeout=true;break}}while(this._continue&&(pos[0]+currRect.getWidth()>=size[0]||pos[1]+currRect.getHeight()>=size[1]));if(isTimeout){continue}newRect=new Rect(pos[0],pos[1],currRect.getWidth(),currRect.getHeight());if(this.isAnyCross(newRect)){continue}else{currRect.setX1(pos[0]);currRect.setY1(pos[1]);count--}}if(this._callback){this.out("RandomPosition get the result");this._callback.call(this,this.getResult())}};RandomPosition.prototype.start=function(callback){this._continue=true;this._callback=callback;var that=this;that.calculate()};RandomPosition.prototype.abort=function(){this._continue=false;if(this._timer){clearTimeout(this._timer)}};RandomPosition.prototype.getResult=function(){this.abort();return this._result};RandomPosition.prototype.out=function(msg){};(function($){var Switcher=function(opt){opt=opt||{};this._arr={};this._event=opt.triggerEvent||"click"};Switcher.prototype.add=function(opt){this._arr[opt.id]=opt};Switcher.prototype.init=function(){for(var i in this._arr){var s=this._arr[i];if(s.trigger){s.trigger.bind(this._event,{switcher:this,id:s.id},function(e){e.data.switcher.switchTo(e.data.id)})}}};Switcher.prototype.switchTo=function(id){for(var i in this._arr){var s=this._arr[i];if(i==id){s.enable()}else{s.disable()}}};Switcher.prototype.enableAll=function(){for(var i in this._arr){var s=this._arr[i];s.enable()}};Switcher.prototype.disableAll=function(){for(var i in this._arr){var s=this._arr[i];s.disable()}};Switcher.prototype.get=function(id){return this._arr[id]};$.Switcher=Switcher})(jQuery);(function($){var Bubble=function(opt){var $container=$('<div class="bubble-container"></div>');var $pointer=$('<span class="bubble-arrow-pointer"></span>');var $body=$(opt.content);$container.append($pointer);$container.append($body);$body.css("dispaly","inline").show();var pointerPos=opt.position.split(" ");$pointer.css(pointerPos[0],"-10px");$pointer.css(pointerPos[1],"10px");if(opt.style){$container.css(opt.style)}if(opt.className){$container.addClass(opt.className)}$container.hide();$(document.body).append($container);this._container=$container;this._pointer=$pointer;this._body=$body;this._position=opt.position;this._defaultTarget=opt.defaultTarget};Bubble.prototype.show=function($target){$target=$target||this._defaultTarget||null;if($target){var targetOffset=$target.offset(),$container=this._container,postions=this._position.split(" "),top="50%",left="50%";this._pointer.addClass("bubble-arrow-pointer-"+postions[0]);switch(postions[0]){case"top":top=targetOffset.top+$target.height()+10;break;case"bottom":top=targetOffset.top-$container.height()-10;break;case"left":left=targetOffset.left+$target.width()+10;break;case"right":left=targetOffset.left-$container.width()-10;break;default:break}switch(postions[1]){case"top":top=targetOffset.top-10;break;case"bottom":top=targetOffset.top-$container.height()+$target.height()/2+20;break;case"left":left=targetOffset.left+$target.width()/2-20;break;case"right":left=targetOffset.left-$container.width()+$target.width()/2+20;break;default:break}$container.css({top:top,left:left})}this._container.show()};Bubble.prototype.hide=function(){this._container.hide()};Bubble.prototype.isShow=function(){return this._container.css("display")!=="none"};Bubble.prototype.setHtml=function(html){this._body.html(html)};Bubble.prototype.setPosition=function(_position){this._position=_position};$.fn.bubble=function(opt,args){if(typeof(opt)=="object"){var $this=$(this);var bubble=$this.data("bubble");if(bubble){return bubble}if(opt.position){var pos=opt.position.split(" ");if(pos.length<2){pos=pos[0];if(pos=="top"||pos=="bottom"){opt.position+=" right"}else{opt.position="top"+opt.position}}}else{opt.position="top right"}opt.content=opt.content||$this;bubble=new Bubble(opt);$this.data("bubble",bubble);return bubble}else{if(typeof(opt)=="string"){var bubble=$(this).data("bubble");if(bubble){bubble[opt](args)}else{throw"bubble: havn't init!"}}else{throw"bubble: argument error!"}}}})(jQuery);(function($){var Loading=function(loadingEl,defaultTarget){this._loadingEl=loadingEl;this._defaultTarget=defaultTarget};Loading.prototype.isShow=function(){return this._loadingEl.css("display")!="none"};Loading.prototype.show=function(target){target=target||this._defaultTarget;this._loadingEl.appendTo(target).center().show()};Loading.prototype.hide=function(){this._loadingEl.hide()};$.Loading=Loading})(jQuery);(function($){var timerShow=function(el,timeout){timeout=timeout||3000;if(el.__timer){clearTimeout(el.__timer)}var timerShowTimout=function(){el.__timer=null;el.hide()};el.show();el.__timer=setTimeout(timerShowTimout,timeout)};var timerHide=function(el){if(el.__timer){clearTimeout(el.__timer)}el.hide()};$.timerShow=timerShow;$.timerHide=timerHide})(jQuery);$(function(){var $container=$("#container"),$datepicker=$("#datepicker"),$pagination=$("#pagination"),$paginationLoading=$("#paginationLoading"),$dataLoading=$("#dataLoading"),$dialog=$("#dialog"),$bubbleTip=$("#bubbleTip"),$footer=$("#footer"),$bill=$("#bill"),$billTable=$("#billTable"),$billTbody=$("#billTbody"),$billTableLoading=$("#billTableLoading"),$newAccountButton=$("#newAccountButton"),$accountForm=$("#accountForm"),$accountDate=$("#accountDate"),$accountAmount=$("#accountAmount"),$accountRemark=$("#accountRemark"),$accountFormTitle=$("#accountFormTitle"),$accountId=$("#accountId"),$accountInTypeDiv=$("#accountInTypeDiv"),$accountInTypeRadio=$("#accountInTypeRadio"),$accountInTypeSelect=$("#accountInTypeSelect"),$accountInTypeLoading=$("#accountInTypeLoading"),$newAccountInTypeButton=$("#newAccountInTypeButton"),$accountOutTypeDiv=$("#accountOutTypeDiv"),$accountOutTypeRadio=$("#accountOutTypeRadio"),$accountOutTypeSelect=$("#accountOutTypeSelect"),$accountOutTypeLoading=$("#accountOutTypeLoading"),$newAccountOutTypeButton=$("#newAccountOutTypeButton"),$accountTypeParent=$("#accountTypeParent"),$accountTypeName=$("#accountTypeName"),$accountTypeVer=$("#accountTypeVer"),$accountTypeAcceptButton=$("#accountTypeAcceptButton"),$accountTypeCancelButton=$("#accountTypeCancelButton"),$accountTypeForm=$("#accountTypeForm"),$customButtonContainer=$("#datepickerCustombtns"),$currentMonth=$("#currentMonth"),$showByMonthButton=$("#showByMonthButton");var CONST={DATE_FORMAT:"yyyy-MM-dd",AMOUNT_REGEX:/[\d\.]+/,DATE_REGEX:/\d{4}-\d{2}-\d{2}/,NUMBER_REGEX:/\d+/,GET_ACCOUNT_TYPE_URL:"ajaxService/get-account-type.php",ADD_ACCOUNT_URL:"ajaxService/add-account.php",EDIT_ACCOUNT_URL:"ajaxService/edit-account.php",GET_ACCOUNT_LIST_URL:"ajaxService/get-account-list.php",GET_ALL_ACCOUNT_LIST_URL:"ajaxService/get-all-account-list.php",ADD_ACCOUNT_TYPE_URL:"ajaxService/add-account-type.php",DEL_ACCOUNT_URL:"ajaxService/del-account.php",GET_SINGLE_ACCOUNT_URL:"ajaxService/get-account.php"};var firstLoad=true,reLoad=false,dataLoading,handlingSubmit=false,accountTypeActionSwitcher,accountTypeActionStateSwitcher,accountFormValidator,accountTypeFormValidator,topZindex=10000,stopYearMonthEvent=false,showByMonth=false,currentYearMonth=[],showByMonthTipTimer,accountTypeStorage={};accountTypeStorage.findById=function(id){var t,r,arr=[this.inType,this.outType];for(var t in arr){for(var i in arr[t]){r=arr[t][i];if(i==id){return r.name}else{if(r.children){for(var c in r.children){if(c==id){return r.children[c].name}}}}}}return"undefinded"};var observer={onDateSelect:function(dateText,instant){reLoad=true;stopYearMonthEvent=false;if(firstLoad){firstLoad=false;currentYearMonth=dateText.format(CONST.DATE_FORMAT).split("-");$container.width(780);$datepicker.css("margin-left","220px");var animateOption={marginLeft:0,fontSize:"1em"};$datepicker.animate(animateOption,500,function(){$billTbody.empty();$billTableLoading.show();$bill.slideDown("normal",function(){ajaxInteraction.loadAccountList(dateText,0,observer.onAccountListLoad)});$customButtonContainer.fadeIn()})}else{$billTbody.empty();$billTableLoading.show();$pagination.hide();ajaxInteraction.loadAccountList(dateText,0,observer.onAccountListLoad)}},onChangeMonthYear:function(year,month,inst){currentYearMonth[0]=year;currentYearMonth[1]=month;if(showByMonth&&!stopYearMonthEvent){$billTbody.empty();$billTableLoading.show();$paginationLoading.hide();ajaxInteraction.loadAllAccountList(year,month,observer.onMonthAccountListLoad)}},onAccountListLoad:function(data){if(data.success){$billTableLoading.hide();$paginationLoading.hide();$billTbody.empty();if(data.total){var record,$tr,trInner;for(var r=0;r<data.records.length;r++){record=data.records[r];$tr=$('<tr class="item">');$tr.attr("id","account-item-"+record.id).attr("aid",record.id).attr("atype",record.accountType);trInner='<td class="index">'+(r+1)+'.</td><td class="date">'+record.addTime+'</td><td class="in-out">'+(record.accountType==1?"收入":"支出")+'</td><td class="amount">'+(record.accountType==1?"＋":"－")+Number.format(record.amount,"#.00")+'</td><td class="type">'+record.categoryName+'</td><td class="remark">'+record.remark+'</td><td class="action"><div><a action="edit" class="button account-edit" href="javascript:void(0);" title="修改"></a><a action="del" class="button account-del" href="javascript:void(0);" title="删除"></a></div></td>';$tr.html(trInner).appendTo($billTbody)}}else{var $tr=$('<tr class="empty"><td colspan="7"><span class="tip2">Sorry, “'+data.date+"”当天没有收支记录.</span></td></tr>");$billTbody.append($tr)}if(reLoad){reLoad=false;$pagination.pagination(data.total,configs.paginationOption)}if(data.total>configs.paginationOption.items_per_page){$pagination.slideDown("slow")}}else{alert(data.code)}},paginationCallback:function(pageId,instant){if(pageId>0){var date=$datepicker.datepicker("getDate");date=date.format(CONST.DATE_FORMAT);$paginationLoading.show();ajaxInteraction.loadAccountList(date,pageId-1,observer.onAccountListLoad)}},onBillTbodyClick:function(e){if(e.target.tagName.toLowerCase()=="a"){if(dataLoading.isShow()){return}var $link=$(e.target);var $tr=$link.parent().parent().parent();var action=$link.attr("action");if(action=="del"){$tr.css("background-color","#ffff00");$dialog.html("<p>你确定要删除该记录?</p>");$dialog.dialog({title:"提示",resizable:false,buttons:{"确定":function(){$dialog.dialog("close");var data={id:$tr.attr("aid"),type:$tr.attr("atype")};dataLoading.show();ajaxInteraction.delAccount(data,observer.onDelAccountSuccess)},"取消":function(){$dialog.dialog("close")}},close:function(){$tr.css("background-color","")}})}else{if(action=="edit"){$tr.css("background-color","#ffff00");var data={id:$tr.attr("aid"),type:$tr.attr("atype")};dataLoading.show();ajaxInteraction.getAccount(data,observer.onGetAccountSuccess)}}}},onNewAccountButtonClick:function(){handlingSubmit=false;accountFormValidator.resetForm();dataLoading.hide();$accountInTypeSelect.empty();$accountOutTypeSelect.empty();accountTypeActionStateSwitcher.enableAll();accountTypeActionSwitcher.switchTo("out");ajaxInteraction.loadAccountType(observer.onAccountTypeLoad);$accountDate.val($datepicker.datepicker("getDate").format(CONST.DATE_FORMAT));$accountId.val("");$accountForm.setDialogTitle("新增收支记录");$accountForm.dialog("open");$accountAmount.focus()},onAccountTypeLoad:function(data){if(data.success){accountTypeStorage.inType=data.inType,accountTypeStorage.outType=data.outType;drawAccountTypeList(accountTypeStorage)}else{alert(data.code)}},onAccountRemarkKeydown:function(e){if(e.keyCode==13){$accountForm.submit()}},onAddAccountSuccess:function(data){dataLoading.hide();if(data.success){$dialog.html("<p>添加成功!</p>");$dialog.dialog({title:"提示",resizable:false,buttons:{"确定":function(){$dialog.dialog("close");handlingSubmit=false;stopYearMonthEvent=true;$datepicker.datepicker("setDate",data.date);observer.onDateSelect.call($datepicker.get(0),data.date);$accountForm.dialog("close")},"继续添加":function(){$accountAmount.val("");$accountRemark.val("");$dialog.dialog("close");handlingSubmit=false;$accountAmount.focus()}}})}else{alert(data.code);handlingSubmit=false}},onNewAccountTypeButtonClick:function(e){var type=e.data.type;if($accountTypeForm.bubble("isShow")&&$accountTypeVer.val()==type){$accountTypeName.val("").focus();return}var options='<option  selected="selected" value="0">顶级</option>';var $this=$(this);if(type=="in"){var types=accountTypeStorage.inType;for(var t in types){options+='<option value="'+types[t].id+'">'+types[t].name+"</option>"}$accountTypeVer.val(1)}else{if(type=="out"){var types=accountTypeStorage.outType;for(var t in types){options+='<option value="'+types[t].id+'">'+types[t].name+"</option>"}$accountTypeVer.val(0)}else{alert("onNewAccountTypeButtonClick - Error");return}}$accountTypeParent.html(options);$accountForm.dialog("disable");$accountTypeForm.bubble("show",$(this));$accountTypeName.val("").focus()},onAddAccountTypeSuccess:function(data){if(data.success){var typeArr,$typeSelect;if(~~data.type){typeArr=accountTypeStorage.inType;$typeSelect=$accountInTypeSelect}else{typeArr=accountTypeStorage.outType;$typeSelect=$accountOutTypeSelect}if(~~data.parent){if(!typeArr[data.parent].children){typeArr[data.parent].children={}}typeArr[data.parent].children[data.id]={id:data.id,name:data.name};var option='<option parent="'+data.parent+'" value="'+data.id+'">&nbsp;&nbsp;&nbsp;&nbsp;'+data.name+"</option>";var lastOption=$typeSelect.find('option[parent="'+data.parent+'"]:last');if(lastOption.length<1){lastOption=$typeSelect.find('option[value="'+data.parent+'"]')}lastOption.after(option);$typeSelect.val(data.id)}else{typeArr[data.id]={id:data.id,name:data.name};var option='<option value="'+data.id+'">'+data.name+"</option>";$typeSelect.append(option);$typeSelect.val(data.id)}var type=~~data.type?"in":"out";accountTypeActionStateSwitcher.get(type).disable()}else{accountTypeActionStateSwitcher.disableAll();alert(data.code)}},onDelAccountSuccess:function(data){dataLoading.hide();if(data.success){var $tr=$("#account-item-"+data.id);$tr.fadeOut("slow",function(){$tr.remove()})}else{alert(data.code)}},onGetAccountSuccess:function(data){if(data.success){var record=data.records;accountFormValidator.resetForm();$accountForm.setDialogTitle("编辑收支记录");var $targetSelect=$accountOutTypeSelect;var type="out";if(~~record.accountType){type="in";$targetSelect=$accountInTypeSelect;$accountInTypeRadio.attr("checked","checked")}$targetSelect.html('<option selected="selected" value="'+record.categoryId+'">'+record.categoryName+"</option>");$accountDate.val(record.addTime);$accountAmount.val(Number.format(record.amount,"#.00"));$accountRemark.val(record.remark);$accountId.val(record.id);accountTypeActionSwitcher.switchTo(type);ajaxInteraction.loadAccountType(observer.onAccountTypeLoad);var $tr=$("#account-item-"+record.id);$accountForm.onCloseCallbacks.push(function(){$tr.css("background-color","")});$accountForm.dialog("open");dataLoading.hide()}else{dataLoading.hide();alert(data.code)}},onEditAccountSuccess:function(data){if(data.success){var record=data.record;var categoryName=accountTypeStorage.findById(record.categoryId);var $tr=$("#account-item-"+record.id);$tr.attr("atype",record.accountType);$tr.children(".date").text(record.addTime);$tr.children(".in-out").text((~~record.accountType?"收入":"支出"));$tr.children(".amount").text((~~record.accountType?"＋":"－")+Number.format(record.amount,"#.00"));$tr.children(".type").text(categoryName);$tr.children(".remark").text(record.remark);$accountForm.dialog("close");dataLoading.hide()}else{dataLoading.hide();alert(data.code)}},onCurrentMonthButtonClick:function(){$billTbody.empty();$billTableLoading.show();$paginationLoading.hide();ajaxInteraction.loadAllAccountList(currentYearMonth[0],currentYearMonth[1],observer.onMonthAccountListLoad)},onShowByMonthButtonMouseEnter:function(){var $this=$(this);showByMonthTipTimer=setTimeout(function(){$bubbleTip.bubble("setHtml",'<div style="width: 150px;padding: 5px 8px;">启用该设置后，切换月份时将显示当月所有收支记录。</div>');$bubbleTip.bubble("show",$this)},300)},onShowByMonthButtonMouseLeave:function(){if(showByMonthTipTimer){clearTimeout(showByMonthTipTimer)}$bubbleTip.bubble("hide")},onShowByMonthButtonClick:function(){if(this.checked){showByMonth=true}else{showByMonth=false}},onMonthAccountListLoad:function(data){if(data.success){$billTableLoading.hide();$billTbody.empty();if(data.total){var record,outCount=0,inCount=0,$tr,trInner,cls;for(var r=0,len=data.records.length;r<len;r++){record=data.records[r];if(~~record.accountType){cls="in";inCount+=parseFloat(record.amount)}else{cls="out";outCount+=parseFloat(record.amount)}$tr=$('<tr class="item '+cls+'">');$tr.attr("id","account-item-"+record.id).attr("aid",record.id).attr("atype",record.accountType);trInner='<td class="index">'+(r+1)+'.</td><td class="date">'+record.addTime+'</td><td class="in-out">'+(record.accountType==1?"收入":"支出")+'</td><td class="amount">'+(record.accountType==1?"＋":"－")+Number.format(record.amount,"#.00")+'</td><td class="type">'+record.categoryName+'</td><td class="remark">'+record.remark+'</td><td class="action"><div><a action="edit" class="button account-edit" href="javascript:void(0);" title="修改"></a><a action="del" class="button account-del" href="javascript:void(0);" title="删除"></a></div></td>';$tr.html(trInner).appendTo($billTbody)}var $tr=$('<tr class="total"><td colspan="7"><span class="tip3">总收入：￥'+inCount.format("#.00")+'</span>　<span class="tip3">总支出：￥'+outCount.format("#.00")+'</span>　<span class="tip3">结算：￥'+(inCount-outCount).format("#.00")+"</span></td></tr>");$billTbody.append($tr)}else{var $tr=$('<tr class="empty"><td colspan="7"><span class="tip2">Sorry, '+data.year+"年"+data.month+"月没有收支记录.</span></td></tr>");$billTbody.append($tr)}}else{alert(data.code)}},emptyFunc:function(){}};var drawAccountTypeList=function(data){var $option="",inType=data.inType,it;for(var i in inType){it=inType[i];$option+='<option value="'+it.id+'">'+it.name+"</option>";if(it.children){for(var c in it.children){var child=it.children;$option+='<option parent="'+it.id+'" value="'+child[c].id+'">&nbsp;&nbsp;&nbsp;&nbsp;'+child[c].name+"</option>"}}}var orginalValue=$accountInTypeSelect.val();$accountInTypeSelect.html($option);if(orginalValue){$accountInTypeSelect.val(orginalValue)}var outType=data.outType,ot;$option="";for(var o in outType){ot=outType[o];$option+='<option value="'+ot.id+'">'+ot.name+"</option>";if(ot.children){for(var c in ot.children){var child=ot.children;$option+='<option parent="'+ot.id+'" value="'+child[c].id+'">&nbsp;&nbsp;&nbsp;&nbsp;'+child[c].name+"</option>"}}}orginalValue=$accountOutTypeSelect.val();$accountOutTypeSelect.html($option);if(orginalValue){$accountOutTypeSelect.val(orginalValue)}$accountInTypeLoading.hide();$newAccountInTypeButton.show();$accountOutTypeLoading.hide();$newAccountOutTypeButton.show()};var ajaxInteraction={loadAccountList:function(date,page,callback){var itemsPerPage=configs.paginationOption.items_per_page;if(page<0){page=0}var start=page*itemsPerPage;var data={date:date,start:start,count:itemsPerPage};$.post(CONST.GET_ACCOUNT_LIST_URL,data,callback)},loadAllAccountList:function(year,month,callback){var data={year:year,month:month};$.post(CONST.GET_ALL_ACCOUNT_LIST_URL,data,callback)},loadAccountType:function(callback){$.post(CONST.GET_ACCOUNT_TYPE_URL,callback)},addNewAccount:function(data,callback){$.post(CONST.ADD_ACCOUNT_URL,data,callback)},addNewAccountType:function(data,callback){$.post(CONST.ADD_ACCOUNT_TYPE_URL,data,callback)},delAccount:function(data,callback){$.post(CONST.DEL_ACCOUNT_URL,data,callback)},getAccount:function(data,callback){$.post(CONST.GET_SINGLE_ACCOUNT_URL,data,callback)}};var configs={mainDateOption:{showButtonPanel:true,onSelect:observer.onDateSelect,onChangeMonthYear:observer.onChangeMonthYear},paginationOption:{items_per_page:10,num_display_entries:5,num_edge_entries:2,current_page:0,callback:observer.paginationCallback},accountFormDialogOption:{autoOpen:false,height:300,width:390,modal:true,resizable:false,show:"fade",hide:"fade",buttons:{"确定":function(){$accountForm.submit()},"取消":function(){$accountForm.dialog("close")}},close:function(){$accountTypeForm.bubble("hide");dataLoading.hide();accountTypeActionSwitcher.disableAll();if($accountForm.onCloseCallbacks&&$accountForm.onCloseCallbacks.length){var callbacks=$accountForm.onCloseCallbacks;while(callback=callbacks.shift()){callback.call(this)}}handlingSubmit=false}},accountDateOption:{showOn:"button",showAnim:"drop",buttonImage:"images/calendar.png",buttonImageOnly:true}};dataLoading=new $.Loading($dataLoading,$container);accountTypeActionSwitcher=new $.Switcher();accountTypeActionSwitcher.add({id:"in",trigger:$accountInTypeRadio,enable:function(){$accountInTypeDiv.removeClass("disable");$accountInTypeSelect.attr("disabled","");$newAccountInTypeButton.bind("click",{type:"in"},observer.onNewAccountTypeButtonClick)},disable:function(){$accountInTypeDiv.addClass("disable");$accountInTypeSelect.attr("disabled","disabled");$newAccountInTypeButton.unbind("click",observer.onNewAccountTypeButtonClick)}});accountTypeActionSwitcher.add({id:"out",trigger:$accountOutTypeRadio,enable:function(){$accountOutTypeDiv.removeClass("disable");$accountOutTypeSelect.attr("disabled","");$newAccountOutTypeButton.bind("click",{type:"out"},observer.onNewAccountTypeButtonClick)},disable:function(){$accountOutTypeDiv.addClass("disable");$accountOutTypeSelect.attr("disabled","disabled");$newAccountOutTypeButton.unbind("click",observer.onNewAccountTypeButtonClick)}});accountTypeActionSwitcher.init();accountTypeActionStateSwitcher=new $.Switcher();accountTypeActionStateSwitcher.add({id:"in",enable:function(){$accountInTypeSelect.attr("disabled","disabled");$accountInTypeLoading.show();$newAccountInTypeButton.hide()},disable:function(){$accountInTypeSelect.attr("disabled","");$accountInTypeLoading.hide();$newAccountInTypeButton.show()}});accountTypeActionStateSwitcher.add({id:"out",enable:function(){$accountOutTypeSelect.attr("disabled","disabled");$accountOutTypeLoading.show();$newAccountOutTypeButton.hide()},disable:function(){$accountOutTypeSelect.attr("disabled","");$accountOutTypeLoading.hide();$newAccountOutTypeButton.show()}});accountTypeActionStateSwitcher.init();$newAccountButton.click(observer.onNewAccountButtonClick);$accountForm.dialog(configs.accountFormDialogOption);$accountRemark.keydown(observer.onAccountRemarkKeydown);$accountForm.dialogTitle=$("#ui-dialog-title-accountForm");$accountForm.setDialogTitle=function(title){$accountForm.dialogTitle.html(title);$accountFormTitle.html(title)};$accountForm.onCloseCallbacks=[];$accountDate.datepicker(configs.accountDateOption);accountFormValidator=$accountForm.validate({submitHandler:function(form){if(handlingSubmit){return}handlingSubmit=true;dataLoading.show($accountForm);if($accountId.val()){$accountForm.ajaxSubmit({url:CONST.EDIT_ACCOUNT_URL,type:"post",success:observer.onEditAccountSuccess})}else{$accountForm.ajaxSubmit({url:CONST.ADD_ACCOUNT_URL,type:"post",success:observer.onAddAccountSuccess})}},messages:{amount:{max:"你有那么多钱么"}}});accountTypeFormValidator=$accountTypeForm.validate({submitHandler:function(form){$accountTypeForm.ajaxSubmit({url:CONST.ADD_ACCOUNT_TYPE_URL,type:"post",success:observer.onAddAccountTypeSuccess})}});$accountTypeForm.bubble({style:{"z-index":topZindex},className:"border3 corner5",position:"top right"});$accountTypeAcceptButton.click(function(){var type=~~$accountTypeVer.val()?"in":"out";accountTypeActionStateSwitcher.get(type).enable();$accountTypeForm.submit();$accountTypeForm.bubble("hide");$accountForm.dialog("enable")});$accountTypeCancelButton.click(function(){$accountTypeForm.bubble("hide");$accountForm.dialog("enable")});$accountTypeName.keydown(function(e){if(e.keyCode==13){$accountTypeAcceptButton.click()}});$bubbleTip.bubble({style:{"z-index":topZindex+1},className:"border3 corner5",position:"top left"});$billTbody.click(observer.onBillTbodyClick);$currentMonth.button().click(observer.onCurrentMonthButtonClick);$showByMonthButton.attr("checked",false);$showByMonthButton.button().button("widget").hover(observer.onShowByMonthButtonMouseEnter,observer.onShowByMonthButtonMouseLeave);$showByMonthButton.change(observer.onShowByMonthButtonClick);$datepicker.datepicker(configs.mainDateOption);$container.fadeIn("slow",function(){$(document.body).removeClass("bodyLoading");$footer.slideDown("slow")})});